<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Mabar Game Matematika Online" />
    <title>Selamat Datang - M. Irfan</title>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;200;300;400;500;600;700;800;900&display=swap" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
    <link rel="stylesheet" href="css/play.css" />
    <link rel="stylesheet" href="style.css" />
    <style>
      .display-option {
        display: grid;
        grid-template-columns: repeat(2, minmax(10rem, 50%));
        margin: 1rem;
        gap: 1rem;
      }
      .display-option .option {
        background-color: white;
        border: 1px solid lightgray;
        height: 5rem;
        border-radius: 7px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        font-weight: medium;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="navbar navbar-light shadow">
        <div class="container">
          <a href="#Id2" class="nav-item nav-link" role="button" data-bs-toggle="offcanvas" aria-controls="Id2"><i class="bx bx-fw bx-menu"></i></a>
          <a href="#" class="navbar-brand">MathBasic</a>
          <!-- <a href="" class="btn btn-sm btn-outline-success"><i class="bx bx-fw bxl-whatsapp"></i>Undang</a> -->
          <div class="dropdown account-information">
            <a role="button" class="my-auto nav-item nav-link" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="bx bx-fw bxs-user-circle"></i></a>
            <ul class="dropdown-menu position-absolute dropdown-menu-end" style="width: 20rem; max-width: 80vmin; text-align: justify">
              <li class="dropdown-item-text text-center display-name">Belum Masuk</li>
              <li class="dropdown-divider"></li>
              <li class="dropdown-item-text">
                <button class="btn btn-sm btn-primary btn-login w-100"><i class="bx bx-fw bxl-google"></i>Masuk Dengan Google</button>
              </li>
              <li class="dropdown-item">
                <button class="btn btn-sm btn-outline-primary w-100 btn-logout"><i class="bx bx-log-out bx-fw"></i>Keluar</button>
              </li>
            </ul>
          </div>
        </div>
        <!-- <div style="height: 1rem; width: 100%"></div> -->
      </nav>

      <div class="offcanvas offcanvas-start" data-bs-backdrop="static" tabindex="-1" id="Id2" aria-labelledby="staticBackdropLabel">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="staticBackdropLabel">MathBasic</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
          <div>Mohon maaf, fitur ini belum tersedia. Silahkan kirim masukan atau saran ke <a href="//api.whatsapp.com/send?phone=6282323864176" target="_blank">Whatsapp Kami.</a></div>
        </div>
      </div>
    </header>

    <!-- <button class="btn-create-room">Buat Room</button> -->
    <main class="mt-3">
      <div class="container">
        <section>
          <div class="room-information">
            <div class="bg-white mb-2 gap-1 d-flex align-items-center justify-content-evenly p-2 rounded" style="border: 1px solid lightgrey">
              <!-- <div class="w-100 text-center text-primary">Kode: <span class="room_code"></span></div>
                <span class="opacity-25">|</span> -->
              <!-- <span class="opacity-25">|</span> -->
              <div class="w-100 text-center">Score: 34</div>
              <span class="opacity-25">|</span>
              <div class="w-100 text-center">47 Detik</div>
              <span class="opacity-25">|</span>
              <!-- <button class="btn btn-sm btn-success p-" title="Undang Teman">Undang</button> -->
              <a href="#collapseGameInfo" data-bs-toggle="collapse" class="btn btn-sm p-1 btn-collapse-chevron collapsed" title="Undang Teman"><i class="bx bx-chevrons-down bx-fw"></i></a>
            </div>

            <div class="collapse" id="collapseGameInfo">
              <div class="bg-white mb-2 p-2 rounded" style="border: 1px solid lightgrey">
                <div>
                  <table>
                    <tr>
                      <td>Kode Room</td>
                      <td class="px-1">:</td>
                      <td><strong class="room-code"></strong></td>
                    </tr>
                    <tr>
                      <td>Pembuat</td>
                      <td class="px-1">:</td>
                      <td><span class="room-author"></span></td>
                    </tr>
                    <tr>
                      <td>Tanggal</td>
                      <td class="px-1">:</td>
                      <td><span class="room-created"></span></td>
                    </tr>
                  </table>
                </div>
                <!-- <p>Lorem ipsum dolor sit, amet consectetur adipisicing elit. Perferendis ducimus iste corrupti doloremque assumenda a commodi qui aliquam quod eius.</p> -->
                <a target="__blank" class="btn btn-success btn-sm mt-2 btn-invite"><i class="bx bxl-whatsapp bx-fw"></i>Undang Teman</a>
              </div>
            </div>
          </div>
        </section>
        <section>
          <div class="display-soal">9 x 15 : 18 = ?</div>

          <div class="display-option">
            <div class="option">65</div>
            <div class="option">45</div>
            <div class="option">67</div>
            <div class="option">87</div>
          </div>
        </section>
        <section>
          <div class="leaderboard mt-3">
            <div><strong>Leaderboard</strong></div>
            <div class="content"></div>
          </div>
        </section>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
    <!-- <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script> -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-analytics.js";
      import { getDatabase, ref, set, onValue, child, get } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";
      import { getAuth, GoogleAuthProvider, onAuthStateChanged, getRedirectResult, signInWithRedirect, signOut } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-auth.js";

      window.onload = () => {
        document.querySelector(".btn-collapse-chevron").click();
      };
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyAkcudM2WZPq3n__YgbWtKUbP2x2Lw8jZY",
        authDomain: "fandev-game-497e8.firebaseapp.com",
        projectId: "fandev-game-497e8",
        storageBucket: "fandev-game-497e8.appspot.com",
        messagingSenderId: "413510404660",
        appId: "1:413510404660:web:4934788d1e787c09c85861",
        measurementId: "G-GP4GQ50TXM",
        databaseURL: "https://fandev-game-497e8-default-rtdb.asia-southeast1.firebasedatabase.app",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getDatabase(app);
      const session = window.sessionStorage;
      const urlParams = new URLSearchParams(window.location.search);

      // Check is set url parameter roomcode
      if (!urlParams.has("room")) window.location.href = "index.html";

      /*=============================================================================
          Awal Authentication
       ============================================================================= */
      const btnLogin = document.querySelector("nav .account-information button.btn-login");
      const btnLogout = document.querySelector("nav .account-information button.btn-logout");
      const displayName = document.querySelector("nav .account-information .display-name");

      const auth = getAuth();
      const provider = new GoogleAuthProvider();
      // provider.addScope("https://www.googleapis.com/auth/contacts.readonly");

      onAuthStateChanged(auth, (user) => {
        if (user) {
          const uid = user.uid;
          session.setItem("uid", uid);
          displayName.innerText = user.displayName;
          console.log("sudah login");
          start();
        } else {
          console.log("belum login");
          session.removeItem("uid");
          displayName.innerText = "Anda Belum Login";
          doSignIn();
          // alert("do Login");
        }
      });
      getRedirectResult(auth)
        .then((result) => {
          if (result) {
            const user = result.user;
            const uid = user.uid;
            session.setItem("uid", uid);
            displayName.innerText = user.displayName;
          }
        })
        .catch((error) => {
          const errorCode = error.code;
          const errorMessage = error.message;
          console.log("error Login", errorMessage);
          // ...
        });
      function doSignIn() {
        signInWithRedirect(auth, provider);
      }
      function doSignOut() {
        signOut(auth)
          .then(() => {
            // Sign-out successful.
            alert("Anda telah keluar");
          })
          .catch((error) => {
            alert("Gagal Logout! Silahkan mencoba kembali.");
            // An error happened.
          });
      }

      btnLogin.onclick = doSignIn;
      btnLogout.onclick = doSignOut;

      /*=============================================================================
          Akhir Authentication
       ============================================================================= */

      const Game = {
        roomCode: urlParams.get("room"),
      };
      document.querySelector(".room-information .room-code").innerText = Game.roomCode;
      document.querySelector(".room-information .btn-invite").href = `//api.whatsapp.com/send?text=Mabar%20yuk%2C%0A${window.location.href}`;

      // console.log(window.location.href);

      // Get Room Information
      function start() {
        if (!session.getItem("uid") || !auth.currentUser) {
          return;
        }
        get(child(ref(db, "rooms"), String(Game.roomCode)))
          .then((snapshot) => {
            if (snapshot.exists()) {
              // Kode room valid
              const data = snapshot.val();
              for (const key in data) Game[key] = data[key];
              if (data.created) Game.created = new Date(data.created);
              if (data.author) document.querySelector(".room-information .room-author").innerText = data.author;
              if (data.created) document.querySelector(".room-information .room-created").innerText = new Date(data.created).toLocaleString();
              // Jika user belum terdaftar sbg player maka daftarkan
              if (!data.hasOwnProperty(session.getItem("uid")))
                set(ref(db, `rooms/${String(Game.roomCode)}/players/${session.getItem("uid")}`), {
                  name: auth.currentUser.displayName,
                  id: session.getItem("uid"),
                  score: 0,
                });
            } else {
              // RoomCode tidak valid
              alert("Maaf, room tidak ditemukan!");
              window.location.href = "index.html";
            }
          })
          .then(() => {
            onValue(ref(db, `rooms/${Game.roomCode}/players`), (snapshot) => {
              if (!snapshot.exists()) return;
              const data = snapshot.val();
              Game.players = data;
              console.log(data);
              const leaderboard = document.querySelector(".leaderboard .content");
              leaderboard.innerText = "";
              for (const player_id in data) {
                const item = document.createElement("div");
                item.classList.add("leaderboard-player");
                item.innerHTML = `<div>${data[player_id]["name"]}</div><div>${data[player_id]["score"]}</div>`;
                leaderboard.appendChild(item);
              }
            });
          })
          .catch((error) => {
            alert("Terjadi kesalahan, silahkan coba lagi.");
            console.log(error);
            // window.location.href = "index.html";
          });
      }
    </script>
  </body>
</html>
